Final working version, without comments.
